<%@page import="com.SVRPlatform.service.VulnerabilityCommentsDisplayService"%>
<%@ page language="java" contentType="text/html;  charset=utf-8"
	import="org.apache.commons.codec.digest.DigestUtils,java.util.List,com.SVRPlatform.data.*"
	pageEncoding="utf-8"%>
<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Vulnerability Comments</title>
<link rel="stylesheet" href="style.css" />
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="showdown.js"></script>
<script type="text/javascript" src="wmd.js"></script>

<style type="text/css">
<%
int commentsPerPage = 5;
String strVulnerabilityNumber = (String)request.getAttribute("strVulnerabilityNumber");
String strCommentsAmount = (String)request.getAttribute("strCommentsAmount");
int commentsAmount = Integer.parseInt(strCommentsAmount);
int pagesAmount;


String strNowPage = (String)request.getAttribute("strNowPage");
int nowPage = Integer.parseInt(strNowPage);
if (commentsAmount % commentsPerPage == 0){
	pagesAmount = commentsAmount / commentsPerPage;
}
else
	pagesAmount = commentsAmount / commentsPerPage + 1;
	out.println("div.commentsfooter {"+
	"width:"+(pagesAmount*33+100) + "px;"+
	"margin: auto;"+
	"padding: inherit;"+
	"padding-top: 50px;"+
	"padding-left: 30px"+
	"height: 50px;"+
	"padding-bottom: 100px;"+
	"clear: both;"+
	"}");
%>

</style>
</head>

<body>
 	<%
 		String stat = (String) request.getAttribute("strStat");
 		System.out.println("strStat == " + request.getAttribute("strStat"));
 		if (stat != null)
	 		if (stat.equals("wrong")){
	 			out.println("<div id=\"wrongmessage\" class=\"alert-messages\" style=\"display:block\">");
	 			out.println("<div class=\"message\">");
	 			out.println("<div class=\"message-inside\">");
	 			out.println("<div class=\"message-text\">");
	%>
		<div>
	 			${message }
	 	</div>
	<%
	 			out.println("</div>");
	 			out.println("<a class=\"dismiss\" href=\"javascript:dismiss();\">Ã—</a>");
	 			out.println("</div>");
	 			out.println("</div>");
	 			out.println("</div>");
	 		}
 	%>
             	<script type="text/javascript">
             		function dismiss(){
             			document.getElementById("wrongmessage").setAttribute("style", "display:none");
             		}
             	</script>

	<%
		String str = (String) session.getAttribute("email");
		if (str != null){
			str = "signedin";
		}
	%>
	<jsp:include page="header.jsp" flush="true">
		<jsp:param name="type" value="<%=str%>" />
	</jsp:include>

	<div id="content">
    		<div id="menu" class="menu">
                <ul>
                	<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </li>
                    <li><a href="vulnerabilitypage?strVulnerabilityNumber=${strVulnerabilityNumber }">VULNERABILITY</a></li>
                    <li><a href="vulnerabilitycomment?strVulnerabilityNumber=${strVulnerabilityNumber }&strNowPage=1">COMMENTS</a></li>
                    <li><a href="displayexploits?strVulnerabilityNumber=${strVulnerabilityNumber }&strNowPage=1#official"><image src="images/logo.png" width="54px" margin="10px"></image>EXPLOITS</a></li>
                    <li><a href="vulnerabilitysolution?strVulnerabilityNumber=${strVulnerabilityNumber }">SOLUTION</a></li>
                </ul>
            </div>
		<hr />
		<div class="comments">
			<div class="commentstitle">${strCommentsAmount } Comments about
				vulnerability ${strVulnerabilityNumber }</div>
			<%
			List<CommentData> commentData = (List) request.getAttribute("commentData");
				for (int i=0; i<commentData.size(); i++){
					
					String hash = commentData.get(i).getEmail();
					if (hash!=null){
						hash = DigestUtils.md5Hex(hash.trim().toLowerCase());
					}
					out.println("<div class='comment'>" + 
					"<div class='commenttitle'>"+commentData.get(i).getTitle()+"</div>" +
				"<div class='commenttext'>"+commentData.get(i).getContent()+"</div>"+
				"<div class='commentfooter'>"+
				"	<div class='commentfooterdate'>Published:"+ commentData.get(i).getDatetime() +
				"	</div>"+
				"	<img class='commentfooteravatar'"+
			"			src='http://www.gravatar.com/avatar/"+	 hash + "'>"+
			"		<div class='commentfooterauthor'>"+
			"			<div class='commentfooterauthorname'>"+
			"				<a href=\"userprofile_display?strEmail="+commentData.get(i).getEmail()+"\" class='msblack20'>"+commentData.get(i).getRealname()+"</a>"+
			"			</div>"+
			"			<div class='commentfooterauthorcredit'>Credits: "+ commentData.get(i).getCredits() +"</div>"+
			"		</div>"+
				"</div>"+
				"</div>");
				}
			%>
			
			
					
					<%
					
/**
* Firstly, we need to output the previous page image link
*/
					out.println("	<div class=\"commentsfooter\">"+
	"					<img class=\"commentsfooterleft\""+
	"						onmouseover=\"this.src='images/leftpressed.png'\""+
	"						onmouseout=\"this.src='images/left.png'\" src=\"images/left.png\"");
						if (nowPage > 1)
							out.print("onclick=\"window.location.href='displayvulnerabilitycomments?strNowPage="+(nowPage-1)+"&strVulnerabilityNumber="+(strVulnerabilityNumber )+"'\">");
						else
							out.print(">");
						
					/**
					* Next, we need to output the links of numbers;
					*/
					
					
					for (int i=1; i<pagesAmount+1; i++){
						if (i == nowPage){
							out.print("<a class=\"commentsfooternow\">"+ i + "</a>");
						}
						else{
							out.print("<a href=\"displayvulnerabilitycomments?strNowPage="+ i +"&strVulnerabilityNumber="+(strVulnerabilityNumber )+"\" class=\"commentsfooterlink\">"+i+"</a>");
						}
					}
					
					/**
					* Finally, we output the next page link image.
					*/
					out.println("					<img class=\"commentsfooterright\""+
							"						onmouseover=\"this.src='images/rightpressed.png'\""+
							"						onmouseout=\"this.src='images/right.png'\" src=\"images/right.png\"");
												
												if (nowPage < pagesAmount)
													out.print("onclick=\"window.location.href='displayvulnerabilitycomments?strNowPage="+(nowPage+1)+"&strVulnerabilityNumber="+(strVulnerabilityNumber )+"'\">");
												else
													out.print(">");	
					out.println("</div>");
					%>
			<div class="commentstitle">Make your comment about vulnerability
				${strVulnerabilityNumber}</div>
			<div class="commentssubmit">
				<form id="commentssubmitform" action="makeVulnerabilityComment" method="post">
					<input type="text" value="${strVulnerabilityNumber}" style="display:none" name="strVulnerabilityNumber">
					<table class="commentssubmittable">
						<tr>
							<td class="commentssubmitkey">&nbsp;</td>
							<td class="commentssubmitvalue"><textarea
									id="commentssubmittitle" name="commentssubmittitle" type="text"
									placeholder="Digest of your comment"></textarea></td>
						</tr>
						<tr>
							<td class="commentssubmitkey">&nbsp;</td>
							<td class="commentssubmitvalue">
								<div id="wmd-editor" class="wmd-panel">
								<div id="wmd-button-bar"></div>
									<textarea
										id="wmd-input" name="commentssubmittext"
										placeholder="Say whatever you want except offensive words"
										class="commentssubmittext"></textarea>
								</div>
								<div id="wmd-preview" class="wmd-panel"></div>
							</td>
						</tr>
						<tr>
							<td>&nbsp;</td>
							<td align="right"><input type="image" alt="submit"
								id="submitbutton" src="images/submitbutton.png"
								onMouseOver="this.src='images/submitbuttonpressed.png'"
								onMouseOut="this.src='images/submitbutton.png'"></td>
						</tr>
					</table>

				</form>
			</div>
		</div>


	</div>

	<jsp:include page="/footer.jsp" flush="true" />
</body>
</html>
