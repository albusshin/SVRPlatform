<%@page import="com.SVRPlatform.Utils.VerifyUser"%>
<%@ page language="java" contentType="text/html;  charset=utf-8"
	import="org.apache.commons.codec.digest.DigestUtils,java.util.List, com.SVRPlatform.data.*"
	pageEncoding="utf-8"%>
<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Exploits - SVRPlatform</title>
	<link rel="stylesheet" href="style.css" />
	<script type="text/javascript" src="jquery.min.js"></script>
	<script type="text/javascript" src="vulnerability.exploits.js"></script>
	<script type="text/javascript" src="showdown.js"></script>
	<script type="text/javascript" src="wmd.js"></script>
    <style type="text/css">
    <%
int exploitsPerPage = 5;
String strVulnerabilityNumber = (String)request.getAttribute("strVulnerabilityNumber");
String strExploitsAmount = (String)request.getAttribute("strExploitsAmount");
int exploitsAmount = Integer.parseInt(strExploitsAmount);
int pagesAmount;
String strIsAlreadyGiven = (String)request.getAttribute("strIsAlreadyGiven");
boolean isAlreadyGiven;
if (strIsAlreadyGiven.equals("true")){
	isAlreadyGiven = true;
}
else{
	isAlreadyGiven = false;
}

String strNowPage = (String)request.getAttribute("strNowPage");
int nowPage = Integer.parseInt(strNowPage);
if (exploitsAmount % exploitsPerPage == 0){
	pagesAmount = exploitsAmount / exploitsPerPage;
}
else
	pagesAmount = exploitsAmount / exploitsPerPage + 1;
	out.println("div.commentsfooter {"+
	"width:"+(pagesAmount*33+100) + "px;"+
	"margin: auto;"+
	"padding: inherit;"+
	"padding-top: 50px;"+
	"padding-left: 30px"+
	"height: 50px;"+
	"padding-bottom: 100px;"+
	"clear: both;"+
	"}");
%>
	</style>
	<script type="text/javascript">

		$(document).ready(function(){
				$('#closeButton').click(function(){
					$('#wrongmessage').hide(1000);
					});
			//if('/${strStat}' === 'wrong')
				if('${strStat}' === 'wrong'){
					$('div.message-text').html("${message}");
					$('#wrongmessage').show(1000);
				}
			});
	
		$(document).ready(function(){ 

			$('#best').animate({
				backgroundColor:"#ff8800",
			}, 50
			);
			$('#best').animate({
				backgroundColor:"#ffffff",
				}, 1000
			);
		});
	</script>
</head>

<body>
	<div id="wrongmessage" class="alert-messages" style="display:none">
		<div class="message">
			<div class="message-inside">
				<div class="message-text">
				</div>
				<label id="closeButton" class="dismiss">×</label> <!--href="javascript:dismiss();" >×</a>-->
			</div>
		</div>
	</div>
             	<script type="text/javascript">
             		function dismiss(){
             			document.getElementById("wrongmessage").setAttribute("style", "display:none");
             		}
             	</script>

	<%
		String str = (String) session.getAttribute("email");
		if (str != null){
			str = "signedin";
		}
	%>
	<jsp:include page="header.jsp" flush="true">
		<jsp:param name="type" value="<%=str%>" />
	</jsp:include>
	
    <div id="content">
    		<div id="menu" class="menu">
                <ul>
                	<li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </li>
                    <li><a href="vulnerabilitypage?strVulnerabilityNumber=${strVulnerabilityNumber }">VULNERABILITY</a></li>
                    <li><a href="displayvulnerabilitycomments?strVulnerabilityNumber=${strVulnerabilityNumber }&strNowPage=1">COMMENTS</a></li>
                    <li><a href="displayvulnerabilityexploits?strVulnerabilityNumber=${strVulnerabilityNumber }&strNowPage=1"><image src="images/logo.png" width="54px" margin="10px"></image>EXPLOITS</a></li>
                    <li><a href="displayvulnerabilitysolution?strVulnerabilityNumber=${strVulnerabilityNumber }">SOLUTION</a></li>
                </ul>
            </div>
		<hr />
<div class="comments">
        	<div class="commentstitle">
            	${strExploitsAmount} Exploits on Vulnerability ${strVulnerabilityNumber}
            </div>
            <%
            List<ExploitData> exploitsData = (List) request.getAttribute("exploitsData");
			for (int i=0; i<exploitsData.size(); i++){
				String hash = exploitsData.get(i).getEmail();
				if (hash!=null){
					hash = DigestUtils.md5Hex(hash.trim().toLowerCase());
				}
				
				out.println("<table class=\"solution\"");
				if (exploitsData.get(i).isBest()){
					out.print("id='best'");
				}
						out.print(">"+
						"<tr class='solutionitself'>"+
						"<td class=\"leftbar\">");
						if (!exploitsData.get(i).isVotedUp())
							out.println("<img class=\"leftbarup\" src=\"images/up.png\" onmouseover=\"this.src='images/uppressed.png'\" onmouseout=\"this.src='images/up.png'\" title=\"This exploit works well for me\" id=\""+ exploitsData.get(i).getExploitID() + "\" >");
						else
							out.println("<img class=\"leftbarup\" src=\"images/upvoted.png\" title=\"Click again to undo\" id=\""+ exploitsData.get(i).getExploitID() + "\" >");
						out.print("<div class=\"leftbarsum\" align=\"center\" title=\"Exploit Score\">"+(exploitsData.get(i).getUp()-exploitsData.get(i).getDown())+"</div>");
						if (!exploitsData.get(i).isVotedDown())
							out.println("<img class=\"leftbardown\" src=\"images/down.png\" onmouseover=\"this.src='images/downpressed.png'\" onmouseout=\"this.src='images/down.png'\" title=\"This exploit seems not working\" id=\""+ exploitsData.get(i).getExploitID() + "\" >");
						else
							out.println("<img class=\"leftbardown\" src=\"images/downvoted.png\" title=\"Click again to undo\" id=\""+ exploitsData.get(i).getExploitID() + "\" >");
				if (exploitsData.get(i).isBest()){
					out.println("<img class=\"leftbarbestofficial\" src=\"images/best.png\" title=\"This exploit is selected as the best answer\">");
				}
						out.println("</td>"+
						"<td class=\"rightcontent\">"+
						"<div class=\"commenttext\">"+exploitsData.get(i).getContent()+"</div>"+
						"<div class=\"commentfooter\">"+
						" <div class=\"commentfooterdate\">"+
						"Published: "+exploitsData.get(i).getDatetime()+
						"</div>"+
						"<img class=\"commentfooteravatar\" src=\"http://www.gravatar.com/avatar/"+	 hash + "\">"+
						
						" <div class=\"commentfooterauthor\">"+
						"<div class=\"commentfooterauthorname\">"+
						"<a href=\"userprofile_display?strEmail="+exploitsData.get(i).getEmail()+"\" class=\"msblack20\">"+exploitsData.get(i).getRealname()+"</a>"+
						" </div>"+
						" <div class=\"commentfooterauthorcredit\">"+
						" Credits:  "+exploitsData.get(i).getCredits()+
						"</div>"+
						"</div>");
								if (exploitsData.get(i).getEmail().equals(VerifyUser.getNowUser(request)))
								{
										out.println("<div class='solutionbuttons'>");
										out.println("<a align='center' onclick=\"document.getElementById('modifysolution').setAttribute('style', 'display:block')\" class=\"edit-button\" href=\"#modify\" >edit</a>");
										out.println("<a align='center' class=\"edit-button  commentsbutton\" slidedown='solutioncommentstable"+exploitsData.get(i).getExploitID()+"' href='javascript:;'id='"+exploitsData.get(i).getExploitID()+"'>comments</a>");
										out.println("</div>");
								}
								else{
									out.println("<div class='solutionbuttons'>");
									out.println("<a align='center' class=\"edit-button  commentsbutton\" slidedown='solutioncommentstable"+exploitsData.get(i).getExploitID()+"' href='javascript:;' id='"+exploitsData.get(i).getExploitID()+"'>comments</a>");
									out.println("</div>");
								}
						out.println("</div>"+
						"</td>"+
						"</tr>"+
						"</table>"+
						"<div id='solutioncommentstable"+exploitsData.get(i).getExploitID()+"' style='display:none'>"+
						"<table class='solutioncommentstable'>"+
				"<tr class='solutioncomment'>");

						String makecommentsolutionhash = VerifyUser.getNowUser(request);
						if (makecommentsolutionhash!=null){
							makecommentsolutionhash = DigestUtils.md5Hex(makecommentsolutionhash.trim().toLowerCase());
						}
			
				out.println("<td class='solutioncommentuseravatartd'><img width='60px' class='solutioncommentuseravatar' src='http://www.gravatar.com/avatar/"+makecommentsolutionhash+"'/></td>"+
				"<td class='solutioncommentauthor'>"+VerifyUser.getNowUserRealname(request)+"</td>"+
				"<td class='solutioncommentcontent'>"+
				"<textarea class='makesolutioncomment' id='content"+exploitsData.get(i).getExploitID()+"'></textarea>"+
          		"<input class='submitcomment' type=\"image\" style='padding-left:20px;' width='50px' id=\""+exploitsData.get(i).getExploitID()+"\" src=\"images/submiticon.png\" onMouseOver=\"this.src='images/submiticonpressed.png'\" onMouseOut=\"this.src='images/submiticon.png'\"\">"+
				"</td>"+
				"</tr>"+
				"</table>"+
				"</div>");
			}
            %>
            <%
            
            
            
					
/**
* Firstly, we need to output the previous page image link
*/
					out.println("	<div class=\"commentsfooter\">"+
	"					<img class=\"commentsfooterleft\""+
	"						onmouseover=\"this.src='images/leftpressed.png'\""+
	"						onmouseout=\"this.src='images/left.png'\" src=\"images/left.png\"");
						if (nowPage > 1)
							out.print("onclick=\"window.location.href='displayvulnerabilityexploits?strNowPage="+(nowPage-1)+"&strVulnerabilityNumber="+(strVulnerabilityNumber )+"'\">");
						else
							out.print(">");
						
					/**
					* Next, we need to output the links of numbers;
					*/
					
					
					for (int i=1; i<pagesAmount+1; i++){
						if (i == nowPage){
							out.print("<a class=\"commentsfooternow\">"+ i + "</a>");
						}
						else{
							out.print("<a href=\"displayvulnerabilityexploits?strNowPage="+ i +"&strVulnerabilityNumber="+(strVulnerabilityNumber )+"\" class=\"commentsfooterlink\">"+i+"</a>");
						}
					}
					
					/**
					* Finally, we output the next page link image.
					*/
					out.println("					<img class=\"commentsfooterright\""+
							"						onmouseover=\"this.src='images/rightpressed.png'\""+
							"						onmouseout=\"this.src='images/right.png'\" src=\"images/right.png\"");
												
												if (nowPage < pagesAmount)
													out.print("onclick=\"window.location.href='displayvulnerabilityexploits?strNowPage="+(nowPage+1)+"&strVulnerabilityNumber="+(strVulnerabilityNumber )+"'\">");
												else
													out.print(">");	
					out.println("</div>");
					
					
					
					if (isAlreadyGiven){
						out.println("<div class=\"commentstitle\">"+
				            	"Modify your exploit on vulnerability "+strVulnerabilityNumber+
				            	"<a name='modify'/>"+
			         "   </div>"+
			          "  <div class=\"commentssubmit\">"+
			            	"<form id=\"solutionmodifyform\" action=\"submitVulnerabilityExploit_edit?strNowPage="+ strNowPage +"\" method=\"post\">"+
			                	"<input type=\"text\" value=\""+ strVulnerabilityNumber +"\" style=\"display:none\" name=\"strVulnerabilityNumber\">"+
			                    "<table class=\"commentssubmittable\">"+
			                       " <tr>"+
			                         "<td class=\"commentssubmitkey\">"+
			                     	" &nbsp;"+
			                        "    </td>"+
			                       "     <td class=\"commentssubmitvalue\">");
			             out.println("<div id=\"wmd-editor\" class=\"wmd-panel\">"
			                     +"<div id=\"wmd-button-bar\"></div>");
			                     out.print("<textarea id=\"wmd-input\" class=\"commentssubmittext\" name=\"exploitsubmittext\">");
			                     for (ExploitData s:exploitsData){
			                     	if (s.getEmail().equals(VerifyUser.getNowUser(request))){
			                     		out.print(s.getContent());
			                     		break;
			                     		/*这里需要转义。*/
			                     	}
			                     }
			                     out.print("</textarea>");
			                     out.println("</div>");
			                     out.println("<div id=\"wmd-preview\" class=\"wmd-panel\"></div>");
			                     out.println("</td>"+
			                            " </tr>"+
			                           "  <tr>"+
			                             	"<td>&nbsp;"+
			                               "  </td>"+
			                         	    "<td align=\"right\">"+
			                       			 	"<input type=\"image\" alt=\"submit\" id=\"submitbutton\" src=\"images/submitbutton.png\" onMouseOver=\"this.src='images/submitbuttonpressed.png'\" onMouseOut=\"this.src='images/submitbutton.png'\">"+
			                            "     </td>"+
			                       "     </tr>"+
			                      "   </table>"+
			                   "  </form></div>   ");
			            }
					if (!isAlreadyGiven){
						out.println("<div class=\"commentstitle\">"+
				            	"Give your exploit on vulnerability "+strVulnerabilityNumber+
			         "   </div>"+
			          "  <div class=\"commentssubmit\">"+
			               " <form id=\"commentssubmitform\" action=\"submitVulnerabilityExploit_execute\" method=\"post\">"+
			                	"<input type=\"text\" value=\""+strVulnerabilityNumber+"\" style=\"display:none\" name=\"strVulnerabilityNumber\">"+
			                   " <table class=\"commentssubmittable\">"+
			                    "    <tr>"+
			                     "       <td class=\"commentssubmitkey\">"+
			                      "      	&nbsp;"+
			                       "     </td>"+
			                        "    <td class=\"commentssubmitvalue\">"+
									"		<div id=\"wmd-editor\" class=\"wmd-panel\">"+
									"			<div id=\"wmd-button-bar\"></div>"+
				                     "       	<textarea id=\"wmd-input\" class=\"commentssubmittext\" name=\"exploitsubmittext\" placeholder=\"Please give useful exploits; provide details and share your research;and do not make casual comments on this page,go to COMMENTS page to do so.\" ></textarea>"+
				                      "      </div>"+
				                       "     <div id=\"wmd-preview\" class=\"wmd-panel\"></div>"+
			                            "</td>"+
			          "              </tr>"+
			          "              <tr>"+
			           "             	<td>&nbsp;"+
			             "               </td>"+
			              "      	    <td align=\"right\">"+
			               "   			 	<input type=\"image\" alt=\"submit\" id=\"submitbutton\" src=\"images/submitbutton.png\" onMouseOver=\"this.src='images/submitbuttonpressed.png'\" onMouseOut=\"this.src='images/submitbutton.png'\">"+
			                "            </td>"+
			                 "       </tr>"+
			                  "  </table>"+
			       "         </form>   "+
			        "    </div>");
					}
					%>
      </div>
    </div>
	<jsp:include page="/footer.jsp" flush="true" />
</body>
</html>
