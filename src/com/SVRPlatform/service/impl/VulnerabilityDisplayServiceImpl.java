package com.SVRPlatform.service.impl;

import java.util.HashMap;
import java.util.Map;

import com.SVRPlatform.dao.ExploitDAO;
import com.SVRPlatform.dao.UserDAO;
import com.SVRPlatform.dao.VulnerabilityDAO;
import com.SVRPlatform.dao.VulnerabilityWatchDAO;
import com.SVRPlatform.model.Exploit;
import com.SVRPlatform.model.Software;
import com.SVRPlatform.model.User;
import com.SVRPlatform.model.Vulnerability;
import com.SVRPlatform.model.VulnerabilitySolution;
import com.SVRPlatform.model.VulnerabilityWatch;
import com.SVRPlatform.service.VulnerabilityDisplayService;

public class VulnerabilityDisplayServiceImpl implements VulnerabilityDisplayService {
	private ExploitDAO exploitDAO;
	private UserDAO userDAO;
	private VulnerabilityDAO vulnerabilityDAO;
	private VulnerabilityWatchDAO vulnerabilityWatchDAO;
	
	public ExploitDAO getExploitDAO() {
		return exploitDAO;
	}

	public void setExploitDAO(ExploitDAO exploitDAO) {
		this.exploitDAO = exploitDAO;
	}

	public UserDAO getUserDAO() {
		return userDAO;
	}

	public void setUserDAO(UserDAO userDAO) {
		this.userDAO = userDAO;
	}

	public VulnerabilityDAO getVulnerabilityDAO() {
		return vulnerabilityDAO;
	}

	public void setVulnerabilityDAO(VulnerabilityDAO vulnerabilityDAO) {
		this.vulnerabilityDAO = vulnerabilityDAO;
	}

	public VulnerabilityWatchDAO getVulnerabilityWatchDAO() {
		return vulnerabilityWatchDAO;
	}

	public void setVulnerabilityWatchDAO(VulnerabilityWatchDAO vulnerabilityWatchDAO) {
		this.vulnerabilityWatchDAO = vulnerabilityWatchDAO;
	}

	public Map<String, String> vulnerabilityDisplay(int userID,	String vulnerabilityNumber) {
		Map<String, String> map = new HashMap<String, String>();
		
		int vulnerabilityID = Integer.parseInt(vulnerabilityNumber.split("-")[2]);		
		Vulnerability vulnerability = (Vulnerability) vulnerabilityDAO.getByID(vulnerabilityID);
		if (vulnerability == null) { 
			map.put("status", "fail");
			return map;
		}
		
		Software software = vulnerability.getSoftware();

		VulnerabilitySolution vulnerabilitySolution;
		if (vulnerability.getVulnerabilitySolution() != null )
			vulnerabilitySolution = vulnerability.getVulnerabilitySolution();
		else vulnerabilitySolution = null;
		
		Exploit exploit;
		if (exploitDAO.getByVulnerability(vulnerability, 1, 0) != null )
			exploit = exploitDAO.getByVulnerability(vulnerability, 1, 0).get(0);
		else exploit = null;
		
		map.put("strVulnerabilityNumber", vulnerability.getVulnerabilityNumber());
		map.put("strVulnerabilityDigest", vulnerability.getVulnerabilityDigest());
		map.put("strDate", vulnerability.getDatetime().toString().substring(0, 16));
		map.put("strScore", Float.toString(vulnerability.getCvssScore()));
		map.put("strConfidentialityImpact", Float.toString(vulnerability.getConfidentialityImpact()));
		map.put("strIntegrityImpact", Float.toString(vulnerability.getIntegrityImpact()));
		map.put("strAvailabilityImpact", Float.toString(vulnerability.getAvailabilityImpact()));
		map.put("strAccessComplexity", Float.toString(vulnerability.getAccessComplexity()));
		map.put("strAuthentication", Float.toString(vulnerability.getAuthentication()));
		map.put("strGainedAccess", Float.toString(vulnerability.getGainedAccess()));
		map.put("strVulnerabilityType", Float.toString(vulnerability.getVulnerabilityTypes()));
		map.put("strScreenshotPath", vulnerability.getGraphAddress());
		map.put("strVulnerabilityDescription", vulnerability.getDescription());
		map.put("strCompany", software.getCompany());
		map.put("strSoftware", software.getName());
		map.put("strVersion", vulnerability.getVersion());
		map.put("strLanguage", vulnerability.getLanguage());
		map.put("strUp", vulnerability.getUp().toString());
		
		VulnerabilityWatch vulnerabilityWatch = vulnerabilityWatchDAO.getByUserAndVulnerability((User)userDAO.getByID(userID), vulnerability);
		if (vulnerabilityWatch != null) {
			if (vulnerabilityWatch.getVoteFlag() == 1) map.put("strVotedUp", "true");
		}
		
		if (vulnerabilitySolution != null)
			map.put("strSolution", vulnerabilitySolution.getContent());
		if (exploit != null)
			map.put("strBestExploit", exploit.getContent());
		
		map.put("status", "success");

		return map;
	}
}
